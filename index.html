<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fluxIQ - 5-Min Options</title>
  <!-- React and ReactDOM from CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel for JSX transpiling -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f7f7f7;
    }
    header {
      background-color: #333;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }
    h2 {
      margin-top: 0;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-right: 10px;
      cursor: pointer;
    }
    pre {
      font-size: 18px;
      font-weight: bold;
      white-space: pre-line;
    }
    .blue-text {
      color: #2962FF;
    }
  </style>
</head>
<body>
  <header>
    <h1>fluxIQ - 5-Min Options</h1>
    <p>Live trading simulation aligned with Eastern Time boundaries</p>
  </header>
  <div id="root"></div>
  
  <!-- Your entire React app -->
  <script type="text/babel">
    // TradingViewWidget component using your provided data
    function TradingViewWidget() {
      const containerRef = React.useRef(null);

      React.useEffect(() => {
        const script = document.createElement("script");
        script.src = "https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js";
        script.type = "text/javascript";
        script.async = true;
        script.innerHTML = `
          {
            "symbols": [
              [
                "FX:EURUSD|1D"
              ]
            ],
            "chartOnly": false,
            "width": "100%",
            "height": "100%",
            "locale": "en",
            "colorTheme": "light",
            "autosize": true,
            "showVolume": true,
            "showMA": true,
            "hideDateRanges": false,
            "hideMarketStatus": false,
            "hideSymbolLogo": false,
            "scalePosition": "right",
            "scaleMode": "Normal",
            "fontFamily": "-apple-system, BlinkMacSystemFont, Trebuchet MS, Roboto, Ubuntu, sans-serif",
            "fontSize": "10",
            "noTimeScale": false,
            "valuesTracking": "3",
            "changeMode": "price-and-percent",
            "chartType": "area",
            "maLineColor": "#2962FF",
            "maLineWidth": 1,
            "maLength": 9,
            "headerFontSize": "medium",
            "lineWidth": 2,
            "lineType": 0,
            "dateRanges": [
              "1d|1",
              "1m|30",
              "3m|60",
              "12m|1D",
              "60m|1W"
            ]
          }`;
        containerRef.current.appendChild(script);
      }, []);

      return (
        <div className="tradingview-widget-container" ref={containerRef} style={{ border: '1px solid #ddd', background: '#fff', minHeight: '500px' }}>
          <div className="tradingview-widget-container__widget"></div>
          <div className="tradingview-widget-copyright">
            <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
              <span className="blue-text">Track all markets on TradingView</span>
            </a>
          </div>
        </div>
      );
    }
    
    // TradeSimulator component for the buy/sell simulation with live data
    function TradeSimulator() {
      const [entryInfo, setEntryInfo] = React.useState('');
      const [profitInfo, setProfitInfo] = React.useState('');
      const [totalProfit, setTotalProfit] = React.useState(0);
      const timerRef = React.useRef(null);

      // Returns the current time in Eastern Time.
      const getEasternTime = () => {
        return new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
      };

      // Fetches the live EUR/USD rate from exchangerate.host.
      const getLivePrice = async () => {
        try {
          const response = await fetch("https://api.exchangerate.host/latest?base=EUR&symbols=USD");
          const data = await response.json();
          return parseFloat(data.rates.USD);
        } catch (error) {
          console.error("Error fetching live price:", error);
          return null;
        }
      };

      // Initiates a trade by fetching the entry price and scheduling an expiration at the next 5-minute boundary.
      const placeTrade = async (direction) => {
        if (timerRef.current) {
          clearTimeout(timerRef.current);
        }
        setProfitInfo('');
        setEntryInfo('Fetching live entry price...');

        const entryPrice = await getLivePrice();
        if (entryPrice === null) {
          setEntryInfo("Failed to fetch live entry price.");
          return;
        }

        // Get Eastern Time and calculate time until the next 5-min boundary.
        const nowET = getEasternTime();
        const minutes = nowET.getMinutes();
        const seconds = nowET.getSeconds();
        const ms = nowET.getMilliseconds();
        let minutesToNextBoundary = 5 - (minutes % 5);
        if (minutes % 5 === 0 && seconds === 0) {
          minutesToNextBoundary = 5;
        }
        const msToNextBoundary = ((minutesToNextBoundary * 60) - seconds) * 1000 - ms;

        const entryMsg = `Entry Price: ${entryPrice.toFixed(5)} (Direction: ${direction.toUpperCase()})
Trade will expire in ${(msToNextBoundary / 1000).toFixed(0)} seconds (next 5‑minute boundary Eastern Time).`;
        setEntryInfo(entryMsg);

        timerRef.current = setTimeout(() => {
          calculateProfit(direction, entryPrice);
        }, msToNextBoundary);
      };

      // At expiration, fetch the exit price, calculate profit, and update cumulative total.
      const calculateProfit = async (direction, entryPrice) => {
        const exitPrice = await getLivePrice();
        if (exitPrice === null) {
          setProfitInfo("Failed to fetch live exit price.");
          return;
        }
        const pipFactor = 10000; // 1 pip = 0.0001 for EUR/USD.
        const priceDifference = (exitPrice - entryPrice) * pipFactor;
        const profit = direction === "buy" ? priceDifference : -priceDifference;
        const newTotalProfit = totalProfit + profit;
        setTotalProfit(newTotalProfit);

        const resultMsg = `Exit Price: ${exitPrice.toFixed(5)}
Trade Result: ${profit.toFixed(2)} pips
Cumulative Profit: ${newTotalProfit.toFixed(2)} pips`;
        setProfitInfo(resultMsg);
      };

      return (
        <div className="trade-simulator" style={{ padding: '20px', border: '1px solid #ddd', background: '#fff', marginTop: '20px' }}>
          <h2>Live Buy/Sell Trade Simulation (5‑Minute Options)</h2>
          <p>Select your prediction for EUR/USD until the next 5‑minute Eastern Time boundary.</p>
          <div style={{ margin: '10px 0' }}>
            <button onClick={() => placeTrade('buy')}>Buy</button>
            <button onClick={() => placeTrade('sell')}>Sell</button>
          </div>
          <pre>{entryInfo}</pre>
          <pre style={{ color: '#1E88E5' }}>{profitInfo}</pre>
          <p style={{ fontSize: '0.9em', color: '#777' }}>
            *This demo uses live data from exchangerate.host and simulates a trade that expires at every 5‑minute boundary (Eastern Time). In a production app, you’d integrate with a broker API.
          </p>
        </div>
      );
    }
    
    // Main App component that combines the TradingViewWidget and TradeSimulator.
    function App() {
      return (
        <div className="container">
          <section style={{ marginBottom: '20px' }}>
            <h2>TradingView Chart</h2>
            <TradingViewWidget />
          </section>
          <section style={{ marginBottom: '20px' }}>
            <TradeSimulator />
          </section>
        </div>
      );
    }
    
    // Render the app.
    const rootElement = document.getElementById("root");
    ReactDOM.createRoot(rootElement).render(<App />);
  </script>
</body>
</html>

